---
author: "Mauricio Rodriguez, Renato Rodriguez, Sebastian Quispe, Christian Salazar, Frings Barrueta" 
title: "Impacto del proceso de vacunación contra la Covid-19"
date: "June 9th 2021"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    number_sections: yes
    theme: journal
---
#Instalacion de librerias
```{r}
install.packages("readr")
install.packages("dplyr")
install.packages ("ggplot2")
install.packages("stringr")
install.packages("scales")
install.packages("lubridate")
install.packages("modeest")
install.packages("viridis")
```

# Cargar librerias 
```{r}
library(readr)
library(dplyr)
library (ggplot2)
library(stringr)
library(scales)
library(lubridate)
library(modeest)
library(viridis)
library(lubridate)
``` 

# Asignar DF's con los datos RAW de los archivos
```{r}
DFFallecidosRAW <- read_csv("fallecidos.csv")
DFVacunadosRAW <- read_csv("vacunados.csv")
```

# Limpieza tabla DFFallecidos
```{r echo = FALSE}
DFFallecidosCLEAN<-subset(DFFallecidosRAW,select = -c(FECHA_CORTE,UUID,UBIGEO,PROVINCIA,DISTRITO))

DFFallecidosCLEAN %>% rename("EDAD"= "EDAD_DECLARADA")-> DFFallecidosCLEAN

vector<-DFFallecidosCLEAN$FECHA_FALLECIMIENTO
dia<-str_sub(vector,-2,-1) #dia
mes<-str_sub(vector,-4,-3) #mes
anio<-str_sub(vector, end = 4) #anio
date = paste(anio,"-",mes,"-",dia, sep = "")
DFFallecidosCLEAN$FECHA_FALLECIMIENTO<- lubridate::ymd(date)
DFFallecidosCLEAN<-filter(DFFallecidosCLEAN,SEXO != "INDETERMINADO")
```

# Limpieza tabla DFVacunados
```{r echo = FALSE}
DFVacunadosCLEAN<-subset(DFVacunadosRAW,select = -c(FECHA_CORTE,UUID,DIRESA,PROVINCIA,DISTRITO))
DFVacunadosCLEAN %>% rename("GRUPO"="GRUPO_RIESGO")-> DFVacunadosCLEAN

vector<-DFVacunadosCLEAN$FECHA_VACUNACION
dia<-str_sub(vector,-2,-1) #dia
mes<-str_sub(vector,-4,-3) #mes
anio<-str_sub(vector, end = 4) #anio
date = paste(anio,"-",mes,"-",dia, sep = "")
DFVacunadosCLEAN$FECHA_VACUNACION<- lubridate::ymd(date)
```


# Figuras de Mérito

## Dataset FALLECIDOS

### FECHA_FALLECIMIENTO
```{r, echo=FALSE}
DFFechaFallecidos <- as.data.frame(table(DFFallecidosCLEAN$FECHA_FALLECIMIENTO))
ggplot(data = DFFallecidosCLEAN, aes(FECHA_FALLECIMIENTO)) + 
  geom_freqpoly() + 
  scale_x_date(date_minor_breaks = "1 day", date_labels = "%b %d") +
  labs(title = "Polígono de dispersión de fallecidos por COVID-19",
       x = "Fecha",
       y = "Cantidad de fallecidos")
```

### EDAD
```{r, echo=FALSE}
ggplot(data = DFFallecidosCLEAN, aes(x=EDAD)) + 
  geom_histogram(aes(fill=..count..)) + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Edades de personas fallecidas por COVID-19",
       x="Edad(años)",
       y="Frecuencia")
```

### SEXO
```{r, echo=FALSE}
options(scipen=999)
barplot(table(DFFallecidosCLEAN$SEXO),
        main="Sexo de personas fallecidas por COVID-19",
        col=c("orange", "blue"),
        legend.text=c("Mujeres", "Hombres"),
        ylim = c(0,150000),
        ylab = "Frecuencia"
)
```


### DEPARTAMENTO


```{r, echo=FALSE}
# Podemos mejorar con una gráfica por cada departamento
ggplot(data = DFFallecidosCLEAN, aes(x=DEPARTAMENTO)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Departamentos de fallecidos por COVID-19",
       x="Departamento",
       y="Frecuencia")
```

## Dataset PROCESO DE VACUNACIÓN

### FECHA_VACUNACION x EDAD
```{r}
ggplot(DFVacunadosCLEAN, aes(FECHA_VACUNACION, EDAD)) + geom_point()
```


### SEXO
```{r, echo=FALSE}
options(scipen=999)
barplot(table(DFVacunadosCLEAN$SEXO),
        main="Sexo de personas vacunadas por COVID-19",
        col=c("orange", "blue"),
        legend.text=c("Mujeres", "Hombres"),
        ylim = c(0,3000000),
        ylab = "Frecuencia"
)
```

### DOSIS
```{r, echo=FALSE}
ggplot(data = DFVacunadosCLEAN, aes(x=DOSIS)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Dosis de vacunas por COVID-19",
       x="Dosis",
       y="Frecuencia")
```

### FABRICANTE
```{r, echo=FALSE}
ggplot(data = DFVacunadosCLEAN, aes(x=FABRICANTE)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Fabricantes de vacunas por COVID-19",
       x="Fabricante",
       y="Frecuencia")
```

### DEPARTAMENTO
```{r, echo=FALSE}
ggplot(data = DFVacunadosCLEAN, aes(y=DEPARTAMENTO)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Departamentos de vacunados por COVID-19",
       x="Frecuencia",
       y="Departamento")
```

# Patrones y descripcion del conjunto de datos
```{r}
#
#
# CODE
#
#
max(DFVacunadosCLEAN$FECHA_VACUNACION)

```


# Variables aleatorias
## Qué tan probable es que eligiendo una persona al azar de nuestra muestra, esta sea un adulto mayor de Lima y haya sido vacunado con el fabricante Pfizer. (No es equiprobable)
```{r}
E1<-(DFVacunadosCLEAN$GRUPO=="ADULTO MAYOR")
E2<-(DFVacunadosCLEAN$DEPARTAMENTO=="LIMA")
E3<-(DFVacunadosCLEAN$FABRICANTE=="PFIZER")

sum(E1&E2&E3)/nrow(DFVacunadosCLEAN)
```

## Qué tan probable es que en UCAYALI exista un adulto mayor con 2 dosis y de género masculino
```{r}
E1<-(DFVacunadosCLEAN$DEPARTAMENTO == "UCAYALI")
E2<-(DFVacunadosCLEAN$GRUPO == "ADULTO MAYOR")
E3<-(DFVacunadosCLEAN$SEXO == "MASCULINO")
E4<-(DFVacunadosCLEAN$DOSIS == 2)
sum(E1&E2&E3&E4)/nrow(DFVacunadosCLEAN)
```

## Qué tan probable es que eligiendo una persona al azar esta sea una mujer y tenga 1 dosis
```{r}
E1<-(DFVacunadosCLEAN$SEXO=="FEMENINO")
E2<-(DFVacunadosCLEAN$DOSIS==1)

sum(E1&E2)/nrow(DFVacunadosCLEAN)
```

## Qué tan probable es que el fabricante de una vacuna aplicada sea sinopharm
```{r}
E1 <- (DFVacunadosCLEAN$FABRICANTE=="SINOPHARM")
E2 <- nrow(DFVacunadosCLEAN)
round(sum(E1)/E2, digits=2)
```


## Qué tan probable es que el género de una persona fallecida sea hombre
```{r}
E1 <- (DFFallecidosCLEAN$SEXO=="MASCULINO")
E2 <- nrow(DFFallecidosCLEAN)
round(sum(E1)/E2, digits=2)
```
## Qué tan probable es que la etapa de vida de una persona fallecida sea adulto mayor(60 a más)
```{r}
E1 <- (DFFallecidosCLEAN$EDAD>=60)
E2 <- nrow(DFFallecidosCLEAN)
round(sum(E1,na.rm=TRUE)/E2, digits=2)
```


# Hipótesis

## Dataset Fallecidos
### Fecha de fallecimiento
HIPÓTESIS: ¿Cómo influye la llegada de las vacunas en la cantidad de fallecidos por COVID?
En lo que va la llegada de las vacunas, el pico más alto de la cantidad de fallecidos fue obtenido durante este periodo.

### Edad
HIPÓTESIS: ¿Será cierto que los adultos mayores son las personas que más fallecieron por COVID?
El rango de edades de la mayor cantidad de personas que fallecieron por COVID está entre 60 y 80 años. 

### Sexo
HIPÓTESIS: ¿Existe alguna diferencia entre la cantidad de fallecidos y su género?
En el Perú, la gran mayoría de personas fallecidas por COVID son hombres.

### Departamento
HIPÓTESIS:¿Es cierto que los departamentos del Norte tienen la mayor cantidad de fallecidos por COVID?
A partir de los gráficos, Lima es la ciudad con mayor cantidad de fallecidos por COVID	

## Dataset Vacunados	
### FECHA_VACUNACION x EDAD
TODO

### Sexo
HIPÓTESIS: ¿Es cierto que el género de la mayor cantidad de personas vacunadas es el mismo que de las personas fallecidas?
No, observamos que la mayor cantidad de personas vacunadas son mujeres.

### Dosis
HIPÓTESIS:¿Existe la misma cantidad de dosis aplicadas en las personas vacunadas del Perú?
No, la mayor cantidad de dosis aplicadas es la primera.

### Fabricante
HIPÓTESIS:
¿Será el mayor fabricante de vacunas del mundo (AstraZeneca) el que distribuye mayor cantidad de vacunas al Perú?
El fabricante que más cantidad de vacunas distribuye al Perú es Pfizer.

### Departamento
¿Es cierto que el departamento con la mayor cantidad de personas vacunadas es el mismo que de las personas fallecidas?
Si, es cierto que el departamento con mayor cantidad de personas vacunadas es Lima.

# Relaciones entre variables

## Primera relación
```{r echo=FALSE}
getEtapa <- function(edad) 
{
  ifelse(edad>60,"Adulto Mayor",ifelse(edad>29,"Adulto",ifelse(edad>17,"Joven","Niño")))
}
```

```{r echo=FALSE}
na.exclude(DFVacunadosCLEAN) %>% mutate(ETAPA = getEtapa(EDAD))%>% group_by(ETAPA,FECHA_VACUNACION) %>% summarize(n = n()) %>% arrange(FECHA_VACUNACION,n)%>% filter(FECHA_VACUNACION>="2021-01-13")

na.exclude(DFFallecidosCLEAN) %>% mutate(ETAPA= getEtapa(EDAD) ) %>% group_by(ETAPA,FECHA_FALLECIMIENTO) %>% summarize(n = n()) %>%
  arrange(FECHA_FALLECIMIENTO,n) %>% filter(FECHA_FALLECIMIENTO>="2021-01-13")
```

## Segunda relación
### Cantidad de fallecidos por departamento en la 2da ola x Cantidad de vacunados por departamento en la 2da ola en el departamento con más vacunados

Calculamos las regiones más vacunados y menos vacunados
```{r echo=FALSE}
table(DFVacunadosCLEAN$DEPARTAMENTO)
which.max(table(DFVacunadosCLEAN$DEPARTAMENTO))
which.min(table(DFVacunadosCLEAN$DEPARTAMENTO))
```
Vemos que Lima es el departamento que tiene más vacunados, y Madre de Dios es que el tiene menos vacunados.

Para Lima
```{r}
# Calculamos fallecidos por departamento
DFFallecidosCLEAN %>% select(DEPARTAMENTO, FECHA_FALLECIMIENTO) %>% 
  filter(DEPARTAMENTO =="LIMA METROPOLITANA" | DEPARTAMENTO == "LIMA REGION") %>% 
  filter(FECHA_FALLECIMIENTO >= as.Date("2021-02-09")) -> fall2daOlaLima
DFfall2daOlaLima <- as.data.frame(table(fall2daOlaLima$FECHA_FALLECIMIENTO), 
                              col.names = c("FECHAS", "CANT_FALLECIDOS"))


# Calculamos vacunados por departamento
DFVacunadosCLEAN %>% select(DEPARTAMENTO, FECHA_VACUNACION) %>% 
  filter(DEPARTAMENTO =="LIMA") %>% 
  filter(FECHA_VACUNACION >= as.Date("2021-02-09") &
         FECHA_VACUNACION <= as.Date("2021-06-07")) -> vac2daOlaLima
DFvac2daOlaLima <- as.data.frame(table(vac2daOlaLima$FECHA_VACUNACION), 
                              col.names = c("FECHAS", "CANT_VACUNADOS"))
cor(DFvac2daOlaLima$Freq, DFfall2daOlaLima$Freq)
```

Distribución de los vacunados y fallecidos en Lima en la segunda Ola
```{r}
# TODO arreglar grafica para que se vean las dos juntas
scatter.smooth(DFvac2daOlaLima)
scatter.smooth(DFfall2daOlaLima)
```


## Tercera relación
### Cantidad de fallecidos por departamento en la 2da ola x Cantidad de vacunados por departamento en la 2da ola en el departamento con menos vacunados

Utilies
```{r}
# Verifica si es que la variable es integer(0) o no
fun_int0 <- function(my_data) {    # Create user-defined function
 
  if(length(my_data) == 0 & is.integer(my_data)) {
 
    return(FALSE)
# [1] "The data object is integer(0)."
 
  } else {
 
    return(TRUE)
# [1] "The data object is NOT integer(0)."
  }
}
```

Para Madre de Dios
```{r}
# Calculamos fallecidos por departamento
DFFallecidosCLEAN %>% select(DEPARTAMENTO, FECHA_FALLECIMIENTO) %>% 
  filter(DEPARTAMENTO =="MADRE DE DIOS") %>% 
  filter(FECHA_FALLECIMIENTO >= as.Date("2021-02-09") &
           FECHA_FALLECIMIENTO <= as.Date("2021-06-03") ) -> fall2daOlaMadDios
DFfall2daOlaMadDios <- as.data.frame(table(fall2daOlaMadDios$FECHA_FALLECIMIENTO), 
                              col.names = c("FECHAS", "CANT_FALLECIDOS"))

# Limpiamos los datos
s <- as.Date("2021-02-11")
e <- as.Date("2021-06-03")
daysCompleteMadDios <- seq(from=s, to=e, by=1)
fallCompleteMadDios <- c()
theDate <- s
while (theDate <= e){
  toSearch <- grep(theDate, DFfall2daOlaMadDios$Var1)
  if(!fun_int0(toSearch)){
    fallCompleteMadDios <- c(fallCompleteMadDios, 0)
  } else {
    fallCompleteMadDios <- c(fallCompleteMadDios, DFfall2daOlaMadDios$Freq[toSearch])
  }
  theDate <- theDate + 1 
}
# dataset final de vacunados en la segunda ola completo
DFfall2daOlaMadDiosComplete <- data.frame(FECHAS=daysCompleteMadDios, 
                                          CANTIDAD=fallCompleteMadDios)

# Calculamos vacunados por departamento
DFVacunadosCLEAN %>% select(DEPARTAMENTO, FECHA_VACUNACION) %>% 
  filter(DEPARTAMENTO =="MADRE DE DIOS") %>% 
  filter(FECHA_VACUNACION >= as.Date("2021-02-09") &
         FECHA_VACUNACION <= as.Date("2021-06-03")) -> vac2daOlaMadDios
DFvac2daOlaMadDios <- as.data.frame(table(vac2daOlaMadDios$FECHA_VACUNACION), 
                              col.names = c("FECHAS", "CANT_VACUNADOS"))

# Limpiamos los datos
s <- as.Date("2021-02-11")
e <- as.Date("2021-06-03")
daysCompleteMadDios <- seq(from=s, to=e, by=1)
vacCompleteMadDios <- c()
theDate <- s
while (theDate <= e){
  toSearch <- grep(theDate, DFvac2daOlaMadDios$Var1)
  if(!fun_int0(toSearch)){
    vacCompleteMadDios <- c(vacCompleteMadDios, 0)
  } else {
    print(DFvac2daOlaMadDios$Freq[toSearch])
    vacCompleteMadDios <- c(vacCompleteMadDios, DFvac2daOlaMadDios$Freq[toSearch])
  }
  theDate <- theDate + 1 
}
# dataset final de vacunados en la segunda ola completo
DFvac2daOlaMadDiosComplete <- data.frame(FECHAS=daysCompleteMadDios, 
                                          CANTIDAD=vacCompleteMadDios)

cor(DFfall2daOlaMadDiosComplete$CANTIDAD, DFvac2daOlaMadDiosComplete$CANTIDAD)
```

Distribución de los vacunados y fallecidos en Madre de Dios en la segunda Ola
```{r}
# TODO arreglar grafica para que se vean las dos juntas
scatter.smooth(DFfall2daOlaMadDiosComplete)
scatter.smooth(DFvac2daOlaMadDiosComplete)
```