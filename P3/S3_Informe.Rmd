---
author: "Mauricio Rodriguez, Renato Rodriguez, Sebastian Quispe, Christian Salazar, Frings Barrueta" 
title: "Impacto del proceso de vacunación contra la Covid-19"
date: "June 11th 2021"
output:
  html_notebook:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    number_sections: yes
    theme: journal
  html_document:
    toc: yes
    df_print: paged
---


# Cargamos librerías
```{r}
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(stringr)
library(scales)
library(lubridate)
library(modeest)
library(viridis)
library(lubridate)
```

# Asignar df's con los datos raw de los archivos
```{r echo=true}
DFFallecidosRAW <- read_csv("fallecidos_covid.csv")
DFVacunadosRAW <- read_csv("vacunas_covid.csv")
```

#Asignar df con las proporciones por departamento
```{r}
DFProporciones <- read_csv("PoblacionTotal.csv")
```
Utilities
```{r warning=FALSE, include=FALSE}
# Verifica si es que la variable es integer(0) o no
fun_int0 <- function(my_data) {    # Create user-defined function
 
  if(length(my_data) == 0 & is.integer(my_data)) {
 
    return(FALSE)
# [1] "The data object is integer(0)."
 
  } else {
 
    return(TRUE)
# [1] "The data object is NOT integer(0)."
  }
}
```

```{r warning=FALSE, include=FALSE}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

# Limpieza tabla DFVacunados
```{r echo = FALSE}
DFVacunadosCLEAN<-subset(DFVacunadosRAW,select = -c(FECHA_CORTE,UUID,DIRESA,PROVINCIA,DISTRITO))
DFVacunadosCLEAN %>% rename("GRUPO"="GRUPO_RIESGO")-> DFVacunadosCLEAN

vector<-DFVacunadosCLEAN$FECHA_VACUNACION
dia<-str_sub(vector,-2,-1) #dia
mes<-str_sub(vector,-4,-3) #mes
anio<-str_sub(vector, end = 4) #anio
date = paste(anio,"-",mes,"-",dia, sep = "")
DFVacunadosCLEAN$FECHA_VACUNACION<- lubridate::ymd(date)

```

```{r}
#suma <- (sum(DFProporciones$POBLACION * 1000))/100
tablaVacunados <- table(DFVacunadosCLEAN$DEPARTAMENTO)

tablaFallecidos <- table(DFFallecidosCLEAN$DEPARTAMENTO)

DFProporciones <-mutate(DFProporciones, porcentajeVacunados = as.double((tablaVacunados[DFProporciones$DEPARTAMENTO])*100/(DFProporciones$POBLACION*1000))/100)

DFProporciones <-mutate(DFProporciones, porcentajeFallecidos = as.double((tablaFallecidos[DFProporciones$DEPARTAMENTO])*100/(DFProporciones$POBLACION*1000))/100)

```



# Limpieza tabla DFFallecidos
```{r echo = FALSE}
DFFallecidosCLEAN<-subset(DFFallecidosRAW,select = -c(FECHA_CORTE,UUID,UBIGEO,PROVINCIA,DISTRITO))

DFFallecidosCLEAN %>% rename("EDAD"= "EDAD_DECLARADA")-> DFFallecidosCLEAN

vector<-DFFallecidosCLEAN$FECHA_FALLECIMIENTO
dia<-str_sub(vector,-2,-1) #dia
mes<-str_sub(vector,-4,-3) #mes
anio<-str_sub(vector, end = 4) #anio
date = paste(anio,"-",mes,"-",dia, sep = "")
DFFallecidosCLEAN$FECHA_FALLECIMIENTO<- lubridate::ymd(date)
DFFallecidosCLEAN<-filter(DFFallecidosCLEAN,SEXO != "INDETERMINADO")
DFFallecidosCLEAN<-filter(DFFallecidosCLEAN,SEXO != "INDETERMINAD")
```




#Análisis descriptivo

##Descriptores Gráficos

### Cantidad de fallecidos por día

Podemos observar claramente cómo han habido dos olas en las que hubo una gran cantidad de fallecidos por día. El gráfico aparenta que el decremento de fallecidos en la segunda ola ha sido más rápido y el número de fallecidos por día ha llegado a niveles inferiores a los de la primera ola. Este descriptor es importante ya que el decremento de fallecimientos de la segunda ola coincide con la llegada de las vacunas al Perú, lo que nos permite estudiar la influencia del proceso de vacunación en el número de fallecimientos.
```{r echo=FALSE, warning=FALSE}
DFFechaFallecidos <- as.data.frame(table(DFFallecidosCLEAN$FECHA_FALLECIMIENTO))
ggplot(data = DFFallecidosCLEAN, aes(FECHA_FALLECIMIENTO)) + 
  geom_freqpoly() + 
  scale_x_date(date_breaks = "2 month", labels = date_format("%b %Y"), limits = as.Date(c('2020-03-03','2021-07-14'))) +
  labs(title = "Polígono de dispersión de fallecidos por COVID-19",
       x = "Fecha",
       y = "Cantidad de fallecidos")
```


### Edades de personas fallecidas por Covid-19
En el diagrama podemos observar en términos de frecuencia las edades que tenían las personas fallecidas por covid. Se visualiza que las edades de las personas que más han fallecido por la pandemia tenían entre 60 y 75 años. Sin embargo, esto no quita el hecho de que gran cantidad de los fallecidos sean personas mayores de 40 años. Esta gráfica nos permite entender cuáles son los rangos de edades más afectados por covid 19 para de esa forma poder enfocar gran parte del estudio en ese sector.
```{r, echo=FALSE, warning=FALSE}
ggplot(data = DFFallecidosCLEAN, aes(x=EDAD)) + 
  geom_histogram(aes(fill=..count..)) + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Edades de personas fallecidas por COVID-19",
       x="Edad(años)",
       y="Frecuencia")
```


### Edades por día de vacunación
En esta gráfica observamos la edad de personas vacunadas en promedio por día. Podemos ver que al inicio del proceso de vacunación las edades en promedio eran de entre 30 y 55 años aproximadamente, esto se explica porque al inicio del proceso de vacunación se priorizó la inoculación de la vacuna a las personas que se encontraban en la primera línea de emergencia; lo cual abarcaba a doctores, enfermeros, bomberos, militares y policías. Esto ocurrió hasta inicios de abril en donde comenzó terminó la vacunación de personal de primera línea y empezó la vacunación de personas mayores, iniciando con los rangos más altos de edad, para lo cual en mayo se puede observar el pico de promedio de edad más alto registrado. Después de esta fecha el promedio ha decrecido a un ritmo parecido a un modelo lineal, aunque conforme pasa el tiempo, disminuye la edad promedio de fallecidos por día y la pendiente de la gráfica tmb se vuelve menos empinada, esto debido a que conforme la edad promedio de vacunados es menor, existe una mayor cantidad de personas a las cuales vacunar para seguir disminuyendo el promedio.
```{r echo=FALSE, warning=FALSE}
DFFechaVacunados <- as.data.frame(table(DFVacunadosCLEAN$FECHA_VACUNACION))
ggplot(data = DFVacunadosCLEAN, aes(x= FECHA_VACUNACION, y = EDAD)) + 
  geom_line(color="indianred3", size=1) +
  geom_smooth()+ 
  scale_x_date(date_breaks = "1 month", labels = date_format("%b %Y"), limits = as.Date(c('2021-02-09','2021-07-14'))) +
  labs(title = "Polígono de frecuencia de fecha de vacunacion y edad contra la COVID-19",
       x = "Fecha de vacunacion",
       y = "Edad") +
  ylim(0,120)
```


### Sexo de personas fallecidas por Covid-19
En este gráfico se aprecia de forma simple y concisa que la cantidad de personas fallecidas por Covid - 19 han sido en su mayoría hombres, siendo que alrededor de 120,000 decesos ocurridos han sido de hombres mientras que menos de 80,000 fueron de mujeres. Esto es útil para estudiar posteriormente el impacto de la vacunación por sexo en los fallecimientos ya que podría haber distinción de este efecto según el sexo.
```{r, echo=FALSE, warning=FALSE}
options(scipen=999)
barplot(table(DFFallecidosCLEAN$SEXO),
        main="Sexo de personas fallecidas por COVID-19",
        col=c("orange", "blue"),
        legend.text=c("Mujeres", "Hombres"),
        ylim = c(0,150000),
        ylab = "Frecuencia"
)
```

### Porcentaje de fallecidos por departamento en proporción a su cantidad de habitantes
La siguiente gráfica muestra el porcentaje de fallecidos con respecto al tamaño poblacional de cada departamento. Observamos como a pesar de que Lima es la región con mayor cantidad de fallecidos, no es el departamento que se ha visto más afectado en términos de densidad poblacional. Vemos como departamentos como Moquegua, cuya población es significativamente menor posee casi el mismo porcentaje de fallecidos que Lima. Asimismo Ica cuya población es mayor a la de Moquegua pero menor a la de Lima ha sido el departamento más afectado tomando en cuenta el número de víctimas fatales por habitantes. Esta gráfica es importante para nuestro estudio dado que estudiar los fallecimientos únicamente tomando en cuenta las cantidades totales, muestran una falsa impresión de que Lima es el departamento más afectado y con creces. En cambio estudiar los fallecimientos en términos de proporciones por departamento nos permite ver más fácilmente el impacto real de la pandemia en cada uno de ellos.
```{r, echo=FALSE, warning=FALSE}
# Podemos mejorar con una gráfica por cada departamento
ggplot(data = DFFallecidosCLEAN, aes(y=DEPARTAMENTO)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Departamentos de fallecidos por COVID-19",
       x="Departamento",
       y="Frecuencia")

```




### Cantidad de personas vacunadas por sexo
En este gráfico se observa que la cantidad de personas vacunadas del sexo femenino es superior a la del sexo masculino, siendo que las personas de sexo femenino han recibido alrededor de 6,000,000 de dosis y las de sexo masculino un número inferior pero entre las 5,500,000 y las 6,000,000 por lo que podríamos decir que la diferencia no es considerable Este gráfico es importante ya que nos indica que el proceso de vacunación se está llevando a cabo de manera prácticamente uniforme en términos de sexo, al menos desde un punto de vista general y no regional.
```{r, echo=FALSE}
options(scipen=999)
barplot(table(DFVacunadosCLEAN$SEXO),
        main="Sexo de personas vacunadas por COVID-19",
        col=c("orange", "blue"),
        legend.text=c("Mujeres", "Hombres"),
        ylim = c(0,6000000),
        ylab = "Frecuencia"
)
```


### Cantidad de personas con 1 o 2 dosis
En el gráfico se observa que la cantidad de personas que han recibido una dosis supera a la que han recibido 2, lo que es totalmente normal considerando que existe una diferencia de días que se deben dar para poder aplicarse la segunda dosis. En específico, la cantidad de personas que han recibido una dosis son alrededor de 7 millones mientras que alrededor de 4 millones han recibido ambas dosis, es decir, que el aproximadamente el 36% de la población vacunada cuenta con ambas dosis. Estos datos son útiles para analizar correctamente el impacto de la vacunación según el número de dosis aplicadas.
```{r, echo=FALSE}
ggplot(data = DFVacunadosCLEAN, aes(x=DOSIS)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Dosis de vacunas por COVID-19",
       x="Dosis",
       y="Frecuencia")
```


### Cantidad de vacunas inoculadas por fabricante
El siguiente gráfico de frecuencias muestra la cantidad de dosis que se han aplicado según el respectivo fabricante de vacunas. Se observa que el fabricante Pfizer, ha sido el principal proveedor de dosis, siendo que en el proceso se han utilizado alrededor de 8 millones de dosis es esta compañía. Muy por debajo, se encuentran los fabricantes Astrazeneca y Sinopharm, cuyas dosis han sido partícipes de alrededor de 2 millones y medio millón  de aplicaciones respectivamente. Esta información es importante ya que nos permite saber cuál ha sido la vacuna más aplicada y su proporción respecto al porcentaje de aplicaciones totales.
```{r, echo=FALSE}
DFVacunadosCLEAN<-filter(DFVacunadosCLEAN,FABRICANTE != "NA")
ggplot(data = DFVacunadosCLEAN, aes(x=FABRICANTE)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Fabricantes de vacunas por COVID-19",
       x="Fabricante",
       y="Frecuencia")
```


### Porcentaje de vacunados por departamento en proporción a su cantidad de habitantes
En esta gráfica observamos los porcentajes de personas vacunadas por departamento en proporción a su densidad poblacional. Si bien sabemos que Lima es el departamento con el mayor número de vacunados, a nivel de porcentajes es superado por Tacna que ya superó el 50% de población inmunizada. En el caso de Puno observamos que el proceso de vacunación es el más lento a comparación del resto de departamento, con solo el 13% de su población inmunizada. Esta gráfica es importante para nuestro estudio porque observamos que el proceso de vacunación no se está llevando a cabo de manera uniforme con respecto a la densidad poblacional de cada departamento.
```{r, echo=FALSE}
ggplot(data = DFVacunadosCLEAN, aes(y=DEPARTAMENTO)) + 
  geom_histogram(aes(fill=..count..), stat = "count") + 
  scale_fill_viridis("Frecuencia", discrete=F) + 
  labs(title="Departamentos de vacunados por COVID-19",
       x="Frecuencia",
       y="Departamento")
```




#Numéricas 

### Edad promedio de fallecidos por Covid-19
Conocer la edad promedio de los fallecidos por Covid-19 nos ayuda a determinar el grupo de edad el cual concentra una mayor cantidad de personas con consecuencias letales durante la pandemia. En nuestro caso obtuvimos que la edad promedio es 66 años, lo que indica que el sector más afectado por la pandemia son los adultos mayores o de tercera edad. Esta información es útil para nuestro estudio ya que podemos saber cuál fue el sector en el que se debió enfocar la atención y recursos médicos durante la emergencia.
```{r, echo=FALSE}
round(mean(DFFallecidosCLEAN$EDAD), digits = 0)
```

### Rango de edad de personas fallecidas a causa de Covid-19
El rango de edad de personas fallecidas a causa de Covid-19 nos indica todas las edades las cuales abarca nuestra muestra. Determinado por el máximo y mínimo de edad, un rango de 117 años. Este dato nos sirve para confirmar que estamos tomando en cuenta todos los datos de fallecidos para cada una de nuestras gráficas en las que utilizamos este dato.
```{r, echo=FALSE}
sprintf("Edad máxima: %s", max(DFFallecidosCLEAN$EDAD))
sprintf("Edad mínima: %s", min(DFFallecidosCLEAN$EDAD))
sprintf("Rango: %s", max(DFFallecidosCLEAN$EDAD) - min(DFFallecidosCLEAN$EDAD))
```
### Edad promedio de vacunados contra Covid-19
La edad promedio de vacunados contra Covid-19 nos indica en qué sector de la población se han realizado la mayor cantidad de vacunas, por ende a cual sector se le ha dado prioridad en esta pandemia. En nuestra muestra la edad promedio de vacunados resultó 60 años, lo que indica que fueron priorizados los adultos mayores en el proceso de vacunación.
```{r, echo=FALSE}
round(mean(DFVacunadosCLEAN$EDAD, na.rm = TRUE), digits = 0)
```

### Rango de edad de personas vacunadas contra Covid-19
El rango de edad de personas vacunadas contra Covid-19 nos indica qué tanto abarca la edad de vacunados en nuestra muestra, con esta información podemos saber cuales son las edades mínima y máxima que fueron vacunadas, y gracias a la información de nuestro dataframe, también podemos saber el motivo de la vacunación de alguna persona menor a la edad de vacunación programada a día de hoy por el MINSA. En nuestra muestra obtuvimos una edad mínima de 17 años, una edad máxima de 134 años y respectivamente un rango de edad de vacunados de 117 años.
```{r, echo=FALSE}
sprintf("Edad máxima: %s", max(DFVacunadosCLEAN$EDAD, na.rm = TRUE))
sprintf("Edad mínima: %s", min(DFVacunadosCLEAN$EDAD, na.rm = TRUE))
sprintf("Rango: %s", max(DFVacunadosCLEAN$EDAD, na.rm = TRUE) - min(DFVacunadosCLEAN$EDAD, na.rm = TRUE))
```



#### Maxima y mínima cantidad de fallecidos
La edad máxima y mínima de fallecidos es útil para nuestro estudio ya que determina el rango máximo y mínimo de edad de nuestra muestra. En nuestra muestra obtuvimos como edad máxima 117 años; como edad mínima 0 años, lo cual indica que hubo menores de edad fallecidos con menos de 1 año de edad. Podemos utilizar estos datos con la edad promedio de fallecidos por covid para determinar cuantos y cuales rangos de edad se han visto seriamente afectados por la Covid-19.
```{r}
max(DFFechaFallecidos$Freq)
min(DFFechaFallecidos$Freq)
```



### Edad máxima y mínima de los fallecidos
La edad máxima y mínima de fallecidos es útil para nuestro estudio ya que determina el rango máximo y mínimo de edad de nuestra muestra. En nuestra muestra obtuvimos como edad máxima 117 años; como edad mínima 0 años, lo cual indica que hubo menores de edad fallecidos con menos de 1 año de edad. Podemos utilizar estos datos con la edad promedio de fallecidos por covid para determinar cuantos y cuales rangos de edad se han visto seriamente afectados por la Covid-19.
```{r}
max(DFFallecidosCLEAN$EDAD,na.rm = TRUE)
min(DFFallecidosCLEAN$EDAD,na.rm = TRUE)
```


### Mayor y menor cantidad de vacunados en un día
Esta información es útil para nuestro estudio porque obteniendo estos límites, podemos calcular cuál ha sido el pico mayor de vacunados en un solo día y comparar dicho extremo con la cantidad mínima de vacunados por día. En nuestra muestra la mayor cantidad de vacunados en un día fue 279826 vacunados, esto recientemente gracias al Vacunaton realizado por MINSA y una cantidad mínima de 90 vacunados, en el día de las elecciones presidenciales. Obteniendo la cantidad promedio de vacunados por día de un determinado periodo podemos hallar la eficacia del estado para suministrar las vacunas a la población. Debido a que la cantidad de vacunados por día es un indicador directo de la eficiencia del estado para enfrentar la pandemia.
```{r}
max(DFFechaVacunados$Freq)
min(DFFechaVacunados$Freq)
```




# Relaciones entre variables

## Primera relación
### Cantidad de fallecidos en la 2da ola por etapa de vida x Cantidad de vacunados en la 2da ola por etapa de vida

Utilities
```{r echo=FALSE}
getEtapa <- function(edad) 
{
  ifelse(edad>60,"Adulto Mayor",ifelse(edad>29,"Adulto",ifelse(edad>17,"Joven","Niño")))
}
```

Etapas de vida
Niños(0-11 años)
Adolescentes (12 - 17 años)
Jóvenes(18 - 29 años)
Adultos (30 -59 años)
Adulto Mayor(60 a más)

Creamos dataset cantidad de fallecidos agrupados por etapa de vida
```{r echo=FALSE}
na.exclude(DFVacunadosCLEAN) %>% mutate(ETAPA = getEtapa(EDAD))%>% group_by(ETAPA,FECHA_VACUNACION) %>% summarize(n = n()) %>% arrange(FECHA_VACUNACION,n)%>% filter(FECHA_VACUNACION>="2021-01-13") -> DFVacEtVida
na.exclude(DFFallecidosCLEAN) %>% mutate(ETAPA= getEtapa(EDAD) ) %>% group_by(ETAPA,FECHA_FALLECIMIENTO) %>% summarize(n = n()) %>%
  arrange(FECHA_FALLECIMIENTO,n) %>% filter(FECHA_FALLECIMIENTO>="2021-01-13") -> DFFallEtVida
```

Para adultos mayores
```{r echo=FALSE}
DFFallEtVida %>% filter(ETAPA == "Adulto Mayor") %>% 
  filter(FECHA_FALLECIMIENTO >= "2021-02-09" ) -> DFFallAdulMay2daOla
DFVacEtVida %>% filter(ETAPA == "Adulto Mayor") %>%
  filter(FECHA_VACUNACION < "2021-07-15")-> DFVacAdulMay2daOla

DFVacAdulMay2daOla <- mutate(DFVacAdulMay2daOla, frecAcumulativa = cumsum(n))
```


###Gráfica de regresión lineal Adultos Mayores
```{r}
plot(DFVacAdulMay2daOla$frecAcumulativa, DFFallAdulMay2daOla$n, pch=20, col=rgb(0,0,0,0.2))
lm1<- lm(DFFallAdulMay2daOla$n ~ DFVacAdulMay2daOla$frecAcumulativa)
abline(lm1, col = "red")
```
```{r}
summary(lm1)
```




Para adultos 
```{r echo=FALSE}
DFFallEtVida %>% filter(ETAPA == "Adulto") %>% 
  filter(FECHA_FALLECIMIENTO >= "2021-02-09" ) -> DFFallAdul2daOla
DFVacEtVida %>% filter(ETAPA == "Adulto") %>%
  filter(FECHA_VACUNACION < "2021-07-14")-> DFVacAdul2daOla

DFVacAdul2daOla <- mutate(DFVacAdul2daOla, frecAcumulativa = cumsum(n))
```


###Gráfica de regresión lineal Adultos
```{r}
plot(DFVacAdul2daOla$frecAcumulativa, DFFallAdul2daOla$n, pch=20, col=rgb(0,0,0,0.2))
lm2<- lm(DFFallAdul2daOla$n ~ DFVacAdul2daOla$frecAcumulativa)
abline(lm2, col = "red")
```

```{r}
summary(lm2)
```



Para jovenes 
```{r echo=FALSE}
DFFallEtVida %>% filter(ETAPA == "Joven") %>% 
  filter(FECHA_FALLECIMIENTO >= "2021-02-09" ) -> DFFallJov2daOla
# Limpiamos los datos
s <- as.Date("2021-02-09")
e <- as.Date("2021-07-14")
daysComplete <- seq(from=s, to=e, by=1)
fallComplete <- c()
theDate <- s
while (theDate <= e){
  toSearch <- grep(theDate, DFFallJov2daOla$FECHA_FALLECIMIENTO)
  if(!fun_int0(toSearch)){
    fallComplete <- c(fallComplete, 0)
  } else {
    fallComplete <- c(fallComplete, DFFallJov2daOla$n[toSearch])
  }
  theDate <- theDate + 1 
}
# dataset final de vacunados en la segunda ola completo
DFFallJov2daOla <- data.frame(FECHA_FALLECIMIENTO=daysComplete, 
                              n=fallComplete)
DFVacEtVida %>% filter(ETAPA == "Joven") %>%
  filter(FECHA_VACUNACION <= "2021-07-14")-> DFVacJov2daOla

DFVacJov2daOla <- mutate(DFVacJov2daOla, frecAcumulativa = cumsum(n))
```


###Gráfica de regresión lineal Jovenes
```{r}
plot(DFVacJov2daOla$frecAcumulativa, DFFallJov2daOla$n, pch=20, col=rgb(0,0,0,0.2))
lm3<- lm(DFFallJov2daOla$n ~ DFVacJov2daOla$frecAcumulativa)
abline(lm3, col = "red")
```

```{r}
summary(lm3)
```




## Segunda relación
### Cantidad de fallecidos por departamento en la 2da ola x Cantidad de vacunados por departamento en la 2da ola en el departamento con más vacunados

Calculamos las regiones más vacunados
```{r echo=FALSE}
table(DFVacunadosCLEAN$DEPARTAMENTO)
which.max(table(DFVacunadosCLEAN$DEPARTAMENTO))
```
Vemos que Lima es el departamento que tiene más vacunados, y Madre de Dios es que el tiene menos vacunados.

Para Lima
```{r}
# Calculamos fallecidos por departamento
DFFallecidosCLEAN %>% select(DEPARTAMENTO, FECHA_FALLECIMIENTO) %>% 
  filter(DEPARTAMENTO =="LIMA") %>% 
  filter(FECHA_FALLECIMIENTO >= as.Date("2021-02-09")) -> fall2daOlaLima
DFfall2daOlaLima <- as.data.frame(table(fall2daOlaLima$FECHA_FALLECIMIENTO), 
                              col.names = c("FECHAS", "CANT_FALLECIDOS"))
# Calculamos vacunados por departamento
DFVacunadosCLEAN %>% select(DEPARTAMENTO, FECHA_VACUNACION) %>% 
  filter(DEPARTAMENTO =="LIMA") %>% 
  filter(FECHA_VACUNACION >= as.Date("2021-02-09") &
         FECHA_VACUNACION <= as.Date("2021-07-14")) -> vac2daOlaLima
DFvac2daOlaLima <- as.data.frame(table(vac2daOlaLima$FECHA_VACUNACION), 
                              col.names = c("FECHAS", "CANT_VACUNADOS"))

DFvac2daOlaLima <- mutate(DFvac2daOlaLima, frecAcumulativa = cumsum(Freq))
```


###Gráfica de regresión Vacunados y Fallecidos en Lima
```{r}
plot(DFvac2daOlaLima$frecAcumulativa, DFfall2daOlaLima$Freq, pch=20, col=rgb(0,0,0,0.2))
lm4<- lm(DFfall2daOlaLima$Freq ~ DFvac2daOlaLima$frecAcumulativa)
abline(lm4, col = "red")
```

```{r}
summary(lm4)
```



## Tercera relación
### Cantidad de fallecidos por departamento en la 2da ola x Cantidad de vacunados por departamento en la 2da ola en el departamento con menos vacunados

```{r echo=FALSE}
table(DFVacunadosCLEAN$DEPARTAMENTO)
which.min(table(DFVacunadosCLEAN$DEPARTAMENTO))
```
Vemos que Madre de Dios es el departamento que menos vacunados.

Para Madre de Dios
```{r}
# Calculamos fallecidos por departamento
DFFallecidosCLEAN %>% select(DEPARTAMENTO, FECHA_FALLECIMIENTO) %>% 
  filter(DEPARTAMENTO =="MADRE DE DIOS") %>% 
  filter(FECHA_FALLECIMIENTO >= as.Date("2021-02-09") &
           FECHA_FALLECIMIENTO <= as.Date("2021-07-14") ) -> fall2daOlaMadDios
DFfall2daOlaMadDios <- as.data.frame(table(fall2daOlaMadDios$FECHA_FALLECIMIENTO), 
                              col.names = c("FECHAS", "CANT_FALLECIDOS"))
# Limpiamos los datos
s <- as.Date("2021-02-11")
e <- as.Date("2021-07-14")
daysCompleteMadDios <- seq(from=s, to=e, by=1)
fallCompleteMadDios <- c()
theDate <- s
while (theDate <= e){
  toSearch <- grep(theDate, DFfall2daOlaMadDios$Var1)
  if(!fun_int0(toSearch)){
    fallCompleteMadDios <- c(fallCompleteMadDios, 0)
  } else {
    fallCompleteMadDios <- c(fallCompleteMadDios, DFfall2daOlaMadDios$Freq[toSearch])
  }
  theDate <- theDate + 1 
}
# dataset final de vacunados en la segunda ola completo
DFfall2daOlaMadDiosComplete <- data.frame(FECHAS=daysCompleteMadDios, 
                                          CANTIDAD=fallCompleteMadDios)
# Calculamos vacunados por departamento
DFVacunadosCLEAN %>% select(DEPARTAMENTO, FECHA_VACUNACION) %>% 
  filter(DEPARTAMENTO =="MADRE DE DIOS") %>% 
  filter(FECHA_VACUNACION >= as.Date("2021-02-09") &
         FECHA_VACUNACION <= as.Date("2021-07-14")) -> vac2daOlaMadDios
DFvac2daOlaMadDios <- as.data.frame(table(vac2daOlaMadDios$FECHA_VACUNACION), 
                              col.names = c("FECHAS", "CANT_VACUNADOS"))
# Limpiamos los datos
s <- as.Date("2021-02-11")
e <- as.Date("2021-07-14")
daysCompleteMadDios <- seq(from=s, to=e, by=1)
vacCompleteMadDios <- c()
theDate <- s
while (theDate <= e){
  toSearch <- grep(theDate, DFvac2daOlaMadDios$Var1)
  if(!fun_int0(toSearch)){
    vacCompleteMadDios <- c(vacCompleteMadDios, 0)
  } else {
    print(DFvac2daOlaMadDios$Freq[toSearch])
    vacCompleteMadDios <- c(vacCompleteMadDios, DFvac2daOlaMadDios$Freq[toSearch])
  }
  theDate <- theDate + 1 
}
# dataset final de vacunados en la segunda ola completo
DFvac2daOlaMadDiosComplete <- data.frame(FECHAS=daysCompleteMadDios, 
                                          CANTIDAD=vacCompleteMadDios)

DFvac2daOlaMadDiosComplete <- mutate(DFvac2daOlaMadDiosComplete, frecAcumulativa = cumsum(CANTIDAD))
```



###Gráfica de regresión Vacunados y Fallecidos en Madre De Dios
```{r}
plot(DFvac2daOlaMadDiosComplete$frecAcumulativa, DFfall2daOlaMadDiosComplete$CANTIDAD, pch=20, col=rgb(0,0,0,0.2))
lm5<- lm(DFfall2daOlaMadDiosComplete$CANTIDAD ~ DFvac2daOlaMadDiosComplete$frecAcumulativa)
abline(lm5, col = "red")
```

```{r}
summary(lm5)
```
